<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>এমসিকিউ টেস্ট সিস্টেম</title>
  <link href="https://fonts.rabeya.com/css?family=SolaimanLipi" rel="stylesheet" type="text/css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    .explanation {
      display: none;
      font-style: italic;
      color: #006400;
      margin-top: 10px;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 5px;
    }
    .option-label.correct {
      color: green;
      font-weight: bold;
    }
    .option-label.wrong {
      color: red;
      font-weight: bold;
    }
    .question-box {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      background-color: #fff;
      margin-bottom: 16px;
      transition: all 0.3s ease;
    }
    .question-box:hover {
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .progress {
      height: 10px;
      margin-bottom: 20px;
    }
    .navbar-brand {
      font-weight: bold;
    }
    #confirmationModal .modal-body {
      font-size: 1.1rem;
    }
    .time-warning {
      color: #dc3545;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    .question-number {
      font-weight: bold;
      color: #0d6efd;
    }
    #resultDetails {
      max-height: 500px;
      overflow-y: auto;
    }
    body {
      font-family: 'SolaimanLipi', 'Siyam Rupali', Arial, sans-serif !important;
      background-color: #f5f7fa;
    }
    .profile-img {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid white;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .result-header {
      background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
      color: white;
      padding: 2rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      text-align: center;
    }
    .score-display {
      font-size: 3rem;
      font-weight: bold;
      color: #28a745;
    }
    .result-card {
      transition: all 0.3s ease;
      border: none;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border-radius: 10px;
    }
    .result-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    .exam-info {
      background-color: #fff;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .question-image {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin: 10px 0;
      border: 1px solid #ddd;
    }
    .option-image {
      max-width: 100px;
      max-height: 100px;
      border-radius: 5px;
      margin-right: 10px;
      border: 1px solid #ddd;
    }
    .image-option-container {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .floating-timer {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #fff;
      padding: 10px 15px;
      border-radius: 50px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      z-index: 1000;
      font-weight: bold;
      border: 2px solid #0d6efd;
    }
    .performance-meter {
      height: 10px;
      border-radius: 5px;
      background: #e9ecef;
      margin: 15px 0;
      overflow: hidden;
    }
    .performance-fill {
      height: 100%;
      background: linear-gradient(90deg, #28a745, #5cb85c);
      width: 0%;
      transition: width 0.5s ease;
    }
    .badge-custom {
      font-size: 0.85em;
      font-weight: normal;
      padding: 5px 10px;
      border-radius: 50px;
    }
    .question-navigation {
      position: sticky;
      top: 20px;
      margin-bottom: 20px;
    }
    .nav-btn {
      width: 40px;
      height: 40px;
      margin: 2px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 5px !important;
    }
    .nav-btn.answered {
      background-color: #28a745;
      color: white;
    }
    .nav-btn.current {
      border: 2px solid #0d6efd;
    }
    .highlight-box {
      background-color: #fff8e1;
      border-left: 4px solid #ffc107;
      padding: 15px;
      border-radius: 0 5px 5px 0;
      margin: 15px 0;
    }
    @media (max-width: 768px) {
      .floating-timer {
        bottom: 10px;
        right: 10px;
        font-size: 0.9em;
        padding: 8px 12px;
      }
      .result-header {
        padding: 1.5rem;
      }
      .score-display {
        font-size: 2.5rem;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container">
      <a class="navbar-brand" href="#">
        <i class="bi bi-journal-bookmark-fill"></i> এমসিকিউ পরীক্ষা সিস্টেম
      </a>
      <div class="d-flex align-items-center">
        <span id="topTimer" class="text-white fw-bold me-3 d-none d-md-inline">সময়: ০০:০০</span>
        <span class="badge bg-light text-dark">
          <i class="bi bi-people-fill"></i> <span id="currentUserTop">অতিথি</span>
        </span>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <!-- Introduction Section -->
    <div id="introSection" class="text-center mb-5">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <h2 class="mb-3"><i class="bi bi-journal-text"></i> এমসিকিউ পরীক্ষায় স্বাগতম</h2>
          <p class="lead">এই পরীক্ষাটি বহুনির্বাচনী প্রশ্ন নিয়ে গঠিত। নিচের নির্দেশাবলী পড়ুন:</p>
          <div class="card border-primary mx-auto">
            <div class="card-header bg-primary text-white">
              <h5 class="card-title mb-0"><i class="bi bi-info-circle"></i> পরীক্ষার নির্দেশাবলী</h5>
            </div>
            <div class="card-body">
              <ul class="text-start list-group list-group-flush">
                <li class="list-group-item"><i class="bi bi-chevron-right"></i> ড্রপডাউন থেকে আপনার নাম নির্বাচন করুন</li>
                <li class="list-group-item"><i class="bi bi-chevron-right"></i> প্রতিটি প্রশ্নের জন্য 30 সেকেন্ড সময় বরাদ্দ থাকবে</li>
                <li class="list-group-item"><i class="bi bi-chevron-right"></i> প্রতিটি প্রশ্নের একটি মাত্র সঠিক উত্তর আছে</li>
                <li class="list-group-item"><i class="bi bi-chevron-right"></i> উত্তর নির্বাচন করলে তাৎক্ষণিকভাবে ফলাফল দেখা যাবে</li>
                <li class="list-group-item"><i class="bi bi-chevron-right"></i> যে কোনো সময় পরীক্ষা জমা দিতে পারবেন</li>
                <li class="list-group-item"><i class="bi bi-chevron-right"></i> প্রশ্নে চিত্র থাকলে সেটি দেখানো হবে</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- User Selection -->
    <div id="userSelection" class="mb-4 text-center">
      <div class="row justify-content-center">
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
              <h5 class="card-title mb-0"><i class="bi bi-person-circle"></i> আপনার পরীক্ষা শুরু করুন</h5>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label for="userSelect" class="form-label">নাম নির্বাচন করুন:</label>
                <select id="userSelect" class="form-select mb-3">
                  <option selected disabled value="">নাম নির্বাচন করুন...</option>
                  <option value="অর্পিতা">অর্পিতা</option>
                  <option value="প্রিয়ন্তী">প্রিয়ন্তী</option>
                  <option value="অতিথি">অতিথি</option>
                </select>
              </div>
              <div class="d-grid gap-2">
                <button class="btn btn-primary" id="startBtn" disabled>
                  <i class="bi bi-play-circle"></i> পরীক্ষা শুরু করুন
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quiz Container -->
    <div id="quizContainer" class="d-none">
      <div class="row">
        <!-- Question Navigation -->
        <div class="col-md-3 col-lg-2 d-none d-md-block">
          <div class="question-navigation">
            <div class="card">
              <div class="card-header bg-light">
                <h6 class="mb-0"><i class="bi bi-list-ol"></i> প্রশ্ন নেভিগেশন</h6>
              </div>
              <div class="card-body p-2">
                <div id="questionNav" class="d-flex flex-wrap"></div>
              </div>
              <div class="card-footer bg-light">
                <small class="text-muted">ক্লিক করে প্রশ্নে যান</small>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Main Quiz Content -->
        <div class="col-md-9 col-lg-10">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <span class="badge bg-primary">
                <i class="bi bi-person"></i> পরীক্ষার্থী: <span id="currentUserDisplay"></span>
              </span>
              <span class="badge bg-info text-dark ms-2">
                <i class="bi bi-question-circle"></i> <span id="answeredCountDisplay">0</span>/<span id="totalCountDisplay">0</span>
              </span>
            </div>
            <div id="timer" class="text-danger fw-bold fs-5 d-none d-md-block">সময়: ০০:০০</div>
          </div>
          
          <div class="progress">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          
          <div class="d-flex justify-content-between mb-4">
            <button id="backToUserBtn" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-left-circle"></i> ব্যবহারকারী পরিবর্তন
            </button>
            <div>
              <button id="submitBtn" class="btn btn-success">
                <i class="bi bi-send-check"></i> পরীক্ষা জমা দিন
              </button>
            </div>
          </div>
          
          <div id="quiz"></div>
          
          <div class="text-center mt-4 mb-5">
            <button id="bottomSubmitBtn" class="btn btn-success btn-lg">
              <i class="bi bi-send-check"></i> পরীক্ষা জমা দিন
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Result Section -->
    <div id="resultSection" class="d-none">
      <div class="result-header">
        <img id="userProfileImg" class="profile-img mb-3" src="" alt="User Profile">
        <h2 id="scoreDisplay" class="mb-2"></h2>
        <div class="score-display" id="scorePercentage"></div>
        <div class="mt-3">
          <span class="badge bg-light text-dark me-2">
            <i class="bi bi-check-circle"></i> <span id="correctCount">0</span>
          </span>
          <span class="badge bg-light text-dark me-2">
            <i class="bi bi-x-circle"></i> <span id="wrongCount">0</span>
          </span>
          <span class="badge bg-light text-dark">
            <i class="bi bi-dash-circle"></i> <span id="unansweredCount">0</span>
          </span>
        </div>
      </div>
      
      <div class="container">
        <div class="row">
          <div class="col-md-6 mb-4">
            <div class="card h-100 result-card">
              <div class="card-body text-center">
                <h5 class="card-title"><i class="bi bi-clipboard-data"></i> পরীক্ষার সারাংশ</h5>
                <div class="mt-4" id="scoreFraction"></div>
                <div class="performance-meter mt-4">
                  <div id="performanceFill" class="performance-fill"></div>
                </div>
                <div class="mt-3" id="timeTaken"></div>
                <div class="mt-3" id="accuracyRate"></div>
                <div class="mt-3" id="completionRate"></div>
                <div class="mt-4">
                  <span class="badge bg-primary badge-custom">
                    <i class="bi bi-award"></i> <span id="performanceLabel">সাধারণ</span>
                  </span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card h-100 result-card">
              <div class="card-body">
                <h5 class="card-title text-center"><i class="bi bi-bar-chart-line"></i> আপনার পারফরম্যান্স</h5>
                <canvas id="resultChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card mt-4 result-card">
          <div class="card-header bg-light">
            <h5 class="mb-0"><i class="bi bi-list-check"></i> বিস্তারিত ফলাফল</h5>
          </div>
          <div class="card-body">
            <div id="resultDetails"></div>
          </div>
        </div>
        
        <div class="text-center mt-4 mb-5">
          <button id="restartBtn" class="btn btn-primary btn-lg">
            <i class="bi bi-arrow-repeat"></i> আবার পরীক্ষা দিন
          </button>
          <button id="newUserBtn" class="btn btn-outline-primary btn-lg ms-3">
            <i class="bi bi-person-plus"></i> নতুন ব্যবহারকারী
          </button>
          <button id="downloadBtn" class="btn btn-success btn-lg ms-3">
            <i class="bi bi-download"></i> ফলাফল ডাউনলোড
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Timer (for mobile) -->
  <div id="floatingTimer" class="floating-timer d-md-none">
    <i class="bi bi-clock"></i> <span id="mobileTimer">00:00</span>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> জমা দেওয়ার নিশ্চিতকরণ</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>আপনি কি নিশ্চিতভাবে আপনার পরীক্ষা জমা দিতে চান?</p>
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> আপনি <span id="answeredCount">০</span> টি প্রশ্নের উত্তর দিয়েছেন <span id="totalCount">০</span> টির মধ্যে।
          </div>
          <div id="estimatedScore" class="text-center fw-bold mt-3"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle"></i> বাতিল
          </button>
          <button type="button" class="btn btn-primary" id="confirmSubmitBtn">
            <i class="bi bi-check-circle"></i> পরীক্ষা জমা দিন
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    // DOM Elements
    const quizEl = document.getElementById("quiz");
    const userSelect = document.getElementById("userSelect");
    const startBtn = document.getElementById("startBtn");
    const quizContainer = document.getElementById("quizContainer");
    const submitBtn = document.getElementById("submitBtn");
    const bottomSubmitBtn = document.getElementById("bottomSubmitBtn");
    const scoreDisplay = document.getElementById("scoreDisplay");
    const timerEl = document.getElementById("timer");
    const mobileTimerEl = document.getElementById("mobileTimer");
    const floatingTimerEl = document.getElementById("floatingTimer");
    const userSelection = document.getElementById("userSelection");
    const introSection = document.getElementById("introSection");
    const resultSection = document.getElementById("resultSection");
    const currentUserDisplay = document.getElementById("currentUserDisplay");
    const currentUserTop = document.getElementById("currentUserTop");
    const progressBar = document.getElementById("progressBar");
    const backToUserBtn = document.getElementById("backToUserBtn");
    const restartBtn = document.getElementById("restartBtn");
    const newUserBtn = document.getElementById("newUserBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    const confirmSubmitBtn = document.getElementById('confirmSubmitBtn');
    const answeredCountEl = document.getElementById('answeredCount');
    const totalCountEl = document.getElementById('totalCount');
    const resultDetailsEl = document.getElementById('resultDetails');
    const scorePercentageEl = document.getElementById('scorePercentage');
    const scoreFractionEl = document.getElementById('scoreFraction');
    const timeTakenEl = document.getElementById('timeTaken');
    const accuracyRateEl = document.getElementById('accuracyRate');
    const completionRateEl = document.getElementById('completionRate');
    const resultChartEl = document.getElementById('resultChart');
    const userProfileImg = document.getElementById('userProfileImg');
    const questionNavEl = document.getElementById('questionNav');
    const answeredCountDisplay = document.getElementById('answeredCountDisplay');
    const totalCountDisplay = document.getElementById('totalCountDisplay');
    const correctCountEl = document.getElementById('correctCount');
    const wrongCountEl = document.getElementById('wrongCount');
    const unansweredCountEl = document.getElementById('unansweredCount');
    const performanceFillEl = document.getElementById('performanceFill');
    const performanceLabelEl = document.getElementById('performanceLabel');
    const estimatedScoreEl = document.getElementById('estimatedScore');
    const topTimerEl = document.getElementById('topTimer');

    // Quiz Variables
    let quizData = [];
    let currentUser = "";
    let score = 0;
    let total = 0;
    let timer;
    let duration = 0;
    let startTime;
    let answeredQuestions = 0;
    let userAnswers = [];
    let currentQuestionIndex = 0;
    const TIME_PER_QUESTION = 30; // 30 seconds per question

    // Initialize
    userSelect.addEventListener("change", () => {
      startBtn.disabled = !userSelect.value;
    });

    startBtn.addEventListener("click", async () => {
      currentUser = userSelect.value;
      currentUserDisplay.textContent = currentUser;
      currentUserTop.textContent = currentUser;
      userSelection.classList.add("d-none");
      introSection.classList.add("d-none");
      quizContainer.classList.remove("d-none");
      document.body.scrollIntoView({ behavior: 'smooth' });
      await loadQuiz();
      startTimer();
      startTime = new Date();
    });

    backToUserBtn.addEventListener("click", () => {
      clearInterval(timer);
      if (answeredQuestions > 0) {
        confirmationModal.hide();
        if (confirm("আপনি ইতিমধ্যে কিছু প্রশ্নের উত্তর দিয়েছেন। আপনি কি নিশ্চিতভাবে ব্যবহারকারী পরিবর্তন করতে চান এবং আপনার অগ্রগতি হারাতে চান?")) {
          resetQuiz();
        }
      } else {
        resetQuiz();
      }
    });

    function resetQuiz() {
      quizContainer.classList.add("d-none");
      userSelection.classList.remove("d-none");
      introSection.classList.remove("d-none");
      score = 0;
      answeredQuestions = 0;
      userAnswers = [];
      duration = 0;
      quizEl.innerHTML = "";
      questionNavEl.innerHTML = "";
      currentQuestionIndex = 0;
      floatingTimerEl.classList.remove('time-warning');
      topTimerEl.classList.remove('time-warning');
    }

    function startTimer() {
      updateTime();
      timer = setInterval(() => {
        duration--;
        updateTime();
        
        if (duration === 30) {
          timerEl.classList.add("time-warning");
          mobileTimerEl.classList.add("time-warning");
          floatingTimerEl.classList.add("time-warning");
          topTimerEl.classList.add("time-warning");
        }
        
        if (duration <= 0) {
          clearInterval(timer);
          submitQuiz();
        }
      }, 1000);
    }

    function updateTime() {
      const min = String(Math.floor(duration / 60)).padStart(2, '০');
      const sec = String(duration % 60).padStart(2, '০');
      timerEl.textContent = `সময়: ${min}:${sec}`;
      mobileTimerEl.textContent = `${min}:${sec}`;
      topTimerEl.textContent = `সময়: ${min}:${sec}`;
      
      const totalTime = total * TIME_PER_QUESTION;
      const progress = ((totalTime - duration) / totalTime) * 100;
      progressBar.style.width = `${progress}%`;
      progressBar.setAttribute('aria-valuenow', progress);
      
      if (duration < 30) {
        progressBar.classList.remove("bg-primary");
        progressBar.classList.add("bg-danger");
      }
    }

    async function loadQuiz() {
      try {
        const loadingHtml = `
          <div class="text-center py-5">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
              <span class="visually-hidden">লোড হচ্ছে...</span>
            </div>
            <p class="mt-3 fs-5">পরীক্ষার প্রশ্ন লোড হচ্ছে...</p>
          </div>
        `;
        quizEl.innerHTML = loadingHtml;
        
        // Add timestamp to URL to prevent caching
        const timestamp = new Date().getTime();
        const res = await fetch(`https://opensheet.elk.sh/1xvjS3P9mzB4FyGvub14r99zWIA3zh7v84WFo_ZLoRV8/1?timestamp=${timestamp}`, {
          cache: "no-store",
          headers: {
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0'
          }
        });
        
        quizData = (await res.json()).filter(q => q["প্রশ্ন"]);
        total = quizData.length;
        duration = total * TIME_PER_QUESTION;
        renderQuiz();
      } catch (e) {
        console.error("Error loading quiz:", e);
        quizEl.innerHTML = `
          <div class="alert alert-danger">
            <h5><i class="bi bi-exclamation-triangle"></i> পরীক্ষা লোড করতে ব্যর্থ হয়েছে</h5>
            <p>আপনার ইন্টারনেট সংযোগ পরীক্ষা করে আবার চেষ্টা করুন।</p>
            <button class="btn btn-warning" onclick="window.location.reload()">
              <i class="bi bi-arrow-clockwise"></i> পৃষ্ঠা রিলোড করুন
            </button>
          </div>
        `;
      }
    }

    function renderQuiz() {
      quizEl.innerHTML = "";
      questionNavEl.innerHTML = "";
      
      // Display exam info
      const totalMinutes = Math.floor(duration / 60);
      quizEl.innerHTML = `
        <div class="exam-info">
          <h5><i class="bi bi-info-circle"></i> পরীক্ষার তথ্য</h5>
          <div class="row">
            <div class="col-md-4">
              <p><i class="bi bi-question-circle"></i> মোট প্রশ্ন: ${total} টি</p>
            </div>
            <div class="col-md-4">
              <p><i class="bi bi-clock"></i> মোট সময়: ${totalMinutes} মিনিট</p>
            </div>
            <div class="col-md-4">
              <p><i class="bi bi-hourglass"></i> অনুত্তরিত প্রশ্ন: ${total} টি</p>
            </div>
          </div>
          <div class="highlight-box">
            <p><i class="bi bi-lightbulb"></i> <strong>পরীক্ষার টিপস:</strong> প্রতিটি প্রশ্নের উত্তর দিলে স্বয়ংক্রিয়ভাবে পরবর্তী প্রশ্নে স্ক্রল হবে।</p>
          </div>
        </div>
      `;
      
      // Render question navigation buttons
      quizData.forEach((q, i) => {
        const navBtn = document.createElement('button');
        navBtn.className = 'btn btn-outline-primary nav-btn';
        navBtn.textContent = q["No."];
        navBtn.title = `প্রশ্ন ${q["No."]} এ যান`;
        navBtn.addEventListener('click', () => {
          document.getElementById(`question-${i}`).scrollIntoView({
            behavior: 'smooth',
            block: 'center'
          });
          updateCurrentQuestion(i);
        });
        questionNavEl.appendChild(navBtn);
      });
      
      // Render questions
      quizData.forEach((q, i) => {
        const div = document.createElement("div");
        div.className = "question-box";
        div.id = `question-${i}`;

        // Check if question has an image
        const questionImage = q["চিত্র"] ? `
          <img src="${q["চিত্র"]}" alt="Question Image" class="question-image img-fluid">
        ` : '';
        
        // Render options with possible images
        const options = ["A", "B", "C", "D"].map(opt => {
          const optionText = q[opt] || "";
          const isImage = optionText.startsWith("http") || optionText.startsWith("data:image");
          
          if (isImage) {
            return `
              <div class="form-check">
                <input class="form-check-input" type="radio" name="q${i}" id="q${i}_${opt}" value="${opt}" data-index="${i}">
                <label class="form-check-label option-label" for="q${i}_${opt}">
                  <div class="image-option-container">
                    <span>${opt})</span>
                    <img src="${optionText}" alt="Option ${opt}" class="option-image">
                  </div>
                </label>
              </div>
            `;
          } else {
            return `
              <div class="form-check">
                <input class="form-check-input" type="radio" name="q${i}" id="q${i}_${opt}" value="${opt}" data-index="${i}">
                <label class="form-check-label option-label" for="q${i}_${opt}">
                  ${opt}) ${optionText}
                </label>
              </div>
            `;
          }
        }).join("");

        div.innerHTML = `
          <h5><span class="question-number">${q["No."]}.</span> ${q["প্রশ্ন"]}</h5>
          ${questionImage}
          ${options}
          <p class="explanation" id="exp${i}">
            <strong><i class="bi bi-lightbulb"></i> ব্যাখ্যা:</strong> ${q["ব্যাখ্যা"] || "কোনো ব্যাখ্যা পাওয়া যায়নি।"}
          </p>
        `;
        quizEl.appendChild(div);
      });

      // Initialize first question as current
      updateCurrentQuestion(0);
      
      // Update counts
      totalCountDisplay.textContent = total;
      answeredCountDisplay.textContent = answeredQuestions;

      // Attach event listeners
      quizData.forEach((q, i) => {
        const inputs = document.querySelectorAll(`input[name="q${i}"]`);
        inputs.forEach(input => {
          input.addEventListener("change", () => {
            const selected = input.value;
            const correct = q["উত্তর"];
            const explanation = document.getElementById(`exp${i}`);
            explanation.style.display = "block";

            // Store user answer
            userAnswers[i] = {
              question: q["প্রশ্ন"],
              selected: selected,
              correct: correct,
              isCorrect: selected === correct,
              explanation: q["ব্যাখ্যা"] || "কোনো ব্যাখ্যা পাওয়া যায়নি।",
              questionNo: q["No."],
              questionImage: q["চিত্র"] || null,
              options: {
                A: q["A"] || "",
                B: q["B"] || "",
                C: q["C"] || "",
                D: q["D"] || ""
              }
            };

            // Disable all inputs for this question
            inputs.forEach(inp => {
              inp.disabled = true;
              const label = document.querySelector(`label[for="${inp.id}"]`);
              label.classList.remove("correct", "wrong");

              if (inp.value === correct) label.classList.add("correct");
              else if (inp.checked && inp.value !== correct) label.classList.add("wrong");
            });

            // Update navigation button
            const navBtn = questionNavEl.children[i];
            navBtn.classList.remove('btn-outline-primary');
            navBtn.classList.add('answered');
            if (selected === correct) {
              navBtn.classList.add('btn-success');
            } else {
              navBtn.classList.add('btn-danger');
            }

            // Update score and answered count
            answeredQuestions++;
            if (selected === correct) score++;
            
            // Update progress
            updateAnsweredProgress();
            
            // Scroll to next unanswered question
            scrollToNextUnanswered();
          });
        });
      });
      
      // Add submit event listeners
      submitBtn.addEventListener("click", showConfirmationModal);
      bottomSubmitBtn.addEventListener("click", showConfirmationModal);
      confirmSubmitBtn.addEventListener("click", submitQuiz);
    }
    
    function updateCurrentQuestion(index) {
      // Remove current class from all nav buttons
      Array.from(questionNavEl.children).forEach(btn => {
        btn.classList.remove('current');
      });
      
      // Add current class to selected question
      if (questionNavEl.children[index]) {
        questionNavEl.children[index].classList.add('current');
      }
      
      currentQuestionIndex = index;
    }
    
    function updateAnsweredProgress() {
      const progress = Math.round((answeredQuestions / total) * 100);
      progressBar.style.width = `${progress}%`;
      progressBar.setAttribute('aria-valuenow', progress);
      progressBar.textContent = `${answeredQuestions}/${total} উত্তর দেওয়া হয়েছে`;
      answeredCountDisplay.textContent = answeredQuestions;
      
      // Update unanswered count in exam info
      const unanswered = total - answeredQuestions;
      const examInfo = document.querySelector('.exam-info');
      if (examInfo) {
        examInfo.querySelector('p:last-child').innerHTML = `<i class="bi bi-hourglass"></i> অনুত্তরিত প্রশ্ন: ${unanswered} টি`;
      }
    }
    
    function scrollToNextUnanswered() {
      for (let i = 0; i < quizData.length; i++) {
        const inputs = document.querySelectorAll(`input[name="q${i}"]`);
        const anyChecked = Array.from(inputs).some(input => input.checked);
        
        if (!anyChecked) {
          document.getElementById(`question-${i}`).scrollIntoView({
            behavior: 'smooth',
            block: 'center'
          });
          updateCurrentQuestion(i);
          break;
        }
      }
    }
    
    function showConfirmationModal() {
      answeredCountEl.textContent = answeredQuestions;
      totalCountEl.textContent = total;
      
      // Calculate estimated score
      const percentage = Math.round((score / answeredQuestions) * 100) || 0;
      const estimatedTotalScore = Math.round((percentage / 100) * total);
      
      estimatedScoreEl.innerHTML = `
        <div class="alert alert-warning">
          <i class="bi bi-graph-up"></i> আনুমানিক স্কোর: ${score}/${answeredQuestions} (${percentage}%)<br>
          যদি বাকি ${total - answeredQuestions} টি প্রশ্নের ${percentage}% সঠিক হয়: ${estimatedTotalScore}/${total}
        </div>
      `;
      
      confirmationModal.show();
    }

    function submitQuiz() {
      clearInterval(timer);
      confirmationModal.hide();
      quizContainer.classList.add("d-none");
      resultSection.classList.remove("d-none");
      
      // Set profile image based on user
      if (currentUser === "প্রিয়ন্তী") {
        userProfileImg.src = "https://i.postimg.cc/zX1Dt2nx/image.png";
      } else if (currentUser === "অর্পিতা") {
        userProfileImg.src = "https://i.postimg.cc/L4DQwnPG/image.png";
      } else {
        userProfileImg.src = "https://i.postimg.cc/0j8XQJ0x/guest.png";
      }
      
      const endTime = new Date();
      const timeTaken = Math.round((endTime - startTime) / 1000);
      const minutes = Math.floor(timeTaken / 60);
      const seconds = timeTaken % 60;
      const percentage = Math.round((score / total) * 100);
      const accuracy = answeredQuestions > 0 ? Math.round((score / answeredQuestions) * 100) : 0;
      const completionRate = Math.round((answeredQuestions / total) * 100);
      
      // Calculate wrong and unanswered counts
      const wrongCount = answeredQuestions - score;
      const unansweredCount = total - answeredQuestions;
      
      // Display results with modern layout
      scoreDisplay.textContent = `${currentUser}-এর ICT পরীক্ষার ফলাফল`;
      scorePercentageEl.textContent = `${percentage}%`;
      scoreFractionEl.innerHTML = `<i class="bi bi-check-circle"></i> <strong>${score} / ${total}</strong> প্রশ্ন সঠিক উত্তর`;
      timeTakenEl.innerHTML = `<i class="bi bi-clock"></i> সময় নিয়েছেন: <strong>${minutes} মিনিট ${seconds} সেকেন্ড</strong>`;
      accuracyRateEl.innerHTML = `<i class="bi bi-speedometer2"></i> সঠিকতার হার: <strong>${accuracy}%</strong>`;
      completionRateEl.innerHTML = `<i class="bi bi-percent"></i> সম্পূর্ণতা: <strong>${completionRate}%</strong>`;
      
      // Update counts
      correctCountEl.textContent = score;
      wrongCountEl.textContent = wrongCount;
      unansweredCountEl.textContent = unansweredCount;
      
      // Update performance meter
      performanceFillEl.style.width = `${percentage}%`;
      
      // Set performance label
      if (percentage >= 80) {
        performanceLabelEl.textContent = "অসাধারণ";
      } else if (percentage >= 60) {
        performanceLabelEl.textContent = "ভালো";
      } else if (percentage >= 40) {
        performanceLabelEl.textContent = "সাধারণ";
      } else {
        performanceLabelEl.textContent = "খারাপ";
      }
      
      // Render detailed results
      renderDetailedResults();
      
      // Render chart
      renderResultChart();
      
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    function renderDetailedResults() {
      let html = '';
      
      quizData.forEach((q, i) => {
        const userAnswer = userAnswers[i] || {
          selected: 'উত্তর দেওয়া হয়নি',
          isCorrect: false,
          explanation: q["ব্যাখ্যা"] || "কোনো ব্যাখ্যা পাওয়া যায়নি।",
          questionNo: q["No."]
        };
        
        // Check if options contain images
        const optionsWithImages = {};
        ["A", "B", "C", "D"].forEach(opt => {
          const optionText = q[opt] || "";
          optionsWithImages[opt] = {
            text: optionText,
            isImage: optionText.startsWith("http") || optionText.startsWith("data:image")
          };
        });
        
        // Question image if exists
        const questionImage = q["চিত্র"] ? `
          <div class="mb-2">
            <strong>প্রশ্নের চিত্র:</strong><br>
            <img src="${q["চিত্র"]}" alt="Question Image" class="question-image img-fluid mt-2">
          </div>
        ` : '';
        
        // Selected answer display
        let selectedAnswerDisplay = '';
        if (userAnswer.selected === 'উত্তর দেওয়া হয়নি') {
          selectedAnswerDisplay = `<span class="text-danger">উত্তর দেওয়া হয়নি</span>`;
        } else {
          if (optionsWithImages[userAnswer.selected].isImage) {
            selectedAnswerDisplay = `
              <span class="${userAnswer.isCorrect ? 'text-success' : 'text-danger'}">
                ${userAnswer.selected}) <img src="${optionsWithImages[userAnswer.selected].text}" alt="Selected Option" class="option-image">
              </span>
            `;
          } else {
            selectedAnswerDisplay = `
              <span class="${userAnswer.isCorrect ? 'text-success' : 'text-danger'}">
                ${userAnswer.selected}) ${optionsWithImages[userAnswer.selected].text}
              </span>
            `;
          }
        }
        
        // Correct answer display
        let correctAnswerDisplay = '';
        if (optionsWithImages[q["উত্তর"]].isImage) {
          correctAnswerDisplay = `
            ${q["উত্তর"]}) <img src="${optionsWithImages[q["উত্তর"]].text}" alt="Correct Option" class="option-image">
          `;
        } else {
          correctAnswerDisplay = `
            ${q["উত্তর"]}) ${optionsWithImages[q["উত্তর"]].text}
          `;
        }
        
        html += `
          <div class="mb-4 p-3 ${userAnswer.isCorrect ? 'bg-success bg-opacity-10' : 'bg-danger bg-opacity-10'} rounded">
            <h5>${q["No."]}. ${q["প্রশ্ন"]}</h5>
            ${questionImage}
            <p class="mb-1"><strong>আপনার উত্তর:</strong> ${selectedAnswerDisplay}</p>
            <p class="mb-1"><strong>সঠিক উত্তর:</strong> ${correctAnswerDisplay}</p>
            <p class="mb-0"><strong><i class="bi bi-lightbulb"></i> ব্যাখ্যা:</strong> ${userAnswer.explanation}</p>
          </div>
        `;
      });
      
      resultDetailsEl.innerHTML = html;
    }
    
    function renderResultChart() {
      const correctCount = score;
      const incorrectCount = answeredQuestions - score;
      const unansweredCount = total - answeredQuestions;
      
      const ctx = resultChartEl.getContext('2d');
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['সঠিক', 'ভুল', 'অনুত্তরিত'],
          datasets: [{
            data: [correctCount, incorrectCount, unansweredCount],
            backgroundColor: [
              '#28a745',
              '#dc3545',
              '#6c757d'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                font: {
                  family: 'SolaimanLipi, Siyam Rupali, Arial, sans-serif'
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const percentage = Math.round((value / total) * 100);
                  return `${label}: ${value} (${percentage}%)`;
                }
              }
            }
          },
          cutout: '70%',
          animation: {
            animateScale: true,
            animateRotate: true
          }
        }
      });
    }
    
    // Download result as image
    downloadBtn.addEventListener('click', () => {
      const resultCard = document.querySelector('.result-header').parentNode;
      
      html2canvas(resultCard, {
        scale: 2,
        logging: false,
        useCORS: true,
        allowTaint: true
      }).then(canvas => {
        const link = document.createElement('a');
        link.download = `${currentUser}-এর-ICT-পরীক্ষার-ফলাফল.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
      });
    });
    
    // Restart buttons
    restartBtn.addEventListener('click', () => {
      resultSection.classList.add('d-none');
      quizContainer.classList.remove('d-none');
      score = 0;
      answeredQuestions = 0;
      userAnswers = [];
      duration = total * TIME_PER_QUESTION;
      startTime = new Date();
      renderQuiz();
      startTimer();
    });
    
    newUserBtn.addEventListener('click', () => {
      resultSection.classList.add('d-none');
      userSelection.classList.remove('d-none');
      introSection.classList.remove('d-none');
      score = 0;
      answeredQuestions = 0;
      userAnswers = [];
      duration = 0;
      quizEl.innerHTML = '';
      questionNavEl.innerHTML = '';
    });

    // Prevent caching by adding meta tags and headers
    window.addEventListener('pageshow', function(event) {
      // If page is loaded from cache, reload it
      if (event.persisted) {
        window.location.reload();
      }
    });
    
    // Handle window resize
    window.addEventListener('resize', () => {
      if (window.innerWidth < 768) {
        floatingTimerEl.classList.remove('d-none');
      } else {
        floatingTimerEl.classList.add('d-none');
      }
    });
  </script>
</body>
</html>
