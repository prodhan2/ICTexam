
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MCQ Test</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .explanation {
      display: none;
      font-style: italic;
      color: #006400;
      margin-top: 10px;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 5px;
    }
    .option-label.correct {
      color: green;
      font-weight: bold;
    }
    .option-label.wrong {
      color: red;
      font-weight: bold;
    }
    .question-box {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      background-color: #fff;
      margin-bottom: 16px;
      transition: all 0.3s ease;
    }
    .question-box:hover {
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .progress {
      height: 10px;
      margin-bottom: 20px;
    }
    .navbar-brand {
      font-weight: bold;
    }
    #confirmationModal .modal-body {
      font-size: 1.1rem;
    }
    .time-warning {
      color: #dc3545;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    .question-number {
      font-weight: bold;
      color: #0d6efd;
    }
    #resultDetails {
      max-height: 500px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container">
      <a class="navbar-brand" href="#">MCQ Examination System</a>
    </div>
  </nav>

  <div class="container py-4">
    <!-- Introduction Section -->
    <div id="introSection" class="text-center mb-5">
      <h2 class="mb-3">Welcome to the MCQ Test</h2>
      <p class="lead">This test consists of multiple-choice questions. You will have 2 minutes to complete it.</p>
      <div class="card mx-auto" style="max-width: 600px;">
        <div class="card-body">
          <h5 class="card-title">Instructions</h5>
          <ul class="text-start">
            <li>Select your name from the dropdown</li>
            <li>You will have 2 minutes to complete the test</li>
            <li>Each question has only one correct answer</li>
            <li>Once you select an answer, it will be locked and evaluated immediately</li>
            <li>You can submit your test at any time</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- User Selection -->
    <div id="userSelection" class="mb-4 text-center">
      <div class="card mx-auto" style="max-width: 400px;">
        <div class="card-body">
          <h5 class="card-title">Begin Your Test</h5>
          <label for="userSelect" class="form-label">Select Your Name:</label>
          <select id="userSelect" class="form-select mb-3">
            <option selected disabled value="">Choose your name...</option>
            <option value="Arpita">Arpita</option>
            <option value="Prionti">Prionti</option>
          </select>
          <button class="btn btn-primary w-100" id="startBtn" disabled>Start Test</button>
        </div>
      </div>
    </div>

    <!-- Quiz Container -->
    <div id="quizContainer" class="d-none">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <span class="badge bg-primary">Candidate: <span id="currentUserDisplay"></span></span>
        </div>
        <div id="timer" class="text-danger fw-bold fs-5">Time: 02:00</div>
      </div>
      
      <div class="progress">
        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
      </div>
      
      <div class="d-flex justify-content-between mb-3">
        <button id="backToUserBtn" class="btn btn-outline-secondary">Change User</button>
        <button id="submitBtn" class="btn btn-success">Submit Test</button>
      </div>
      
      <div id="quiz"></div>
      
      <div class="text-center mt-4">
        <button id="bottomSubmitBtn" class="btn btn-success btn-lg">Submit Test</button>
      </div>
    </div>

    <!-- Result Section -->
    <div id="resultSection" class="d-none">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h3 class="card-title mb-0">Test Results</h3>
        </div>
        <div class="card-body">
          <h4 id="scoreDisplay" class="text-center mb-4"></h4>
          
          <div class="row">
            <div class="col-md-6 mb-4">
              <div class="card h-100">
                <div class="card-body text-center">
                  <h5 class="card-title">Summary</h5>
                  <div class="display-4" id="scorePercentage"></div>
                  <div class="mt-2" id="scoreFraction"></div>
                  <div class="mt-3" id="timeTaken"></div>
                </div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="card h-100">
                <div class="card-body">
                  <h5 class="card-title text-center">Performance</h5>
                  <canvas id="resultChart"></canvas>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card mt-4">
            <div class="card-header">
              <h5 class="mb-0">Detailed Results</h5>
            </div>
            <div class="card-body">
              <div id="resultDetails"></div>
            </div>
          </div>
          
          <div class="text-center mt-4">
            <button id="restartBtn" class="btn btn-primary">Take Test Again</button>
            <button id="newUserBtn" class="btn btn-outline-primary ms-2">New User</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Submission</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to submit your test?</p>
          <p>You have answered <span id="answeredCount">0</span> out of <span id="totalCount">0</span> questions.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmSubmitBtn">Submit Test</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // DOM Elements
    const quizEl = document.getElementById("quiz");
    const userSelect = document.getElementById("userSelect");
    const startBtn = document.getElementById("startBtn");
    const quizContainer = document.getElementById("quizContainer");
    const submitBtn = document.getElementById("submitBtn");
    const bottomSubmitBtn = document.getElementById("bottomSubmitBtn");
    const scoreDisplay = document.getElementById("scoreDisplay");
    const timerEl = document.getElementById("timer");
    const userSelection = document.getElementById("userSelection");
    const introSection = document.getElementById("introSection");
    const resultSection = document.getElementById("resultSection");
    const currentUserDisplay = document.getElementById("currentUserDisplay");
    const progressBar = document.getElementById("progressBar");
    const backToUserBtn = document.getElementById("backToUserBtn");
    const restartBtn = document.getElementById("restartBtn");
    const newUserBtn = document.getElementById("newUserBtn");
    const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    const confirmSubmitBtn = document.getElementById('confirmSubmitBtn');
    const answeredCountEl = document.getElementById('answeredCount');
    const totalCountEl = document.getElementById('totalCount');
    const resultDetailsEl = document.getElementById('resultDetails');
    const scorePercentageEl = document.getElementById('scorePercentage');
    const scoreFractionEl = document.getElementById('scoreFraction');
    const timeTakenEl = document.getElementById('timeTaken');
    const resultChartEl = document.getElementById('resultChart');

    // Quiz Variables
    let quizData = [];
    let currentUser = "";
    let score = 0;
    let total = 0;
    let timer;
    let duration = 120;
    let startTime;
    let answeredQuestions = 0;
    let userAnswers = [];

    // Initialize
    userSelect.addEventListener("change", () => {
      startBtn.disabled = !userSelect.value;
    });

    startBtn.addEventListener("click", async () => {
      currentUser = userSelect.value;
      currentUserDisplay.textContent = currentUser;
      userSelection.classList.add("d-none");
      introSection.classList.add("d-none");
      quizContainer.classList.remove("d-none");
      document.body.scrollIntoView({ behavior: 'smooth' });
      await loadQuiz();
      startTimer();
      startTime = new Date();
    });

    backToUserBtn.addEventListener("click", () => {
      clearInterval(timer);
      if (answeredQuestions > 0) {
        if (confirm("You have already answered some questions. Are you sure you want to change user and lose your progress?")) {
          resetQuiz();
        }
      } else {
        resetQuiz();
      }
    });

    function resetQuiz() {
      quizContainer.classList.add("d-none");
      userSelection.classList.remove("d-none");
      introSection.classList.remove("d-none");
      score = 0;
      answeredQuestions = 0;
      userAnswers = [];
      duration = 120;
      quizEl.innerHTML = "";
    }

    function startTimer() {
      updateTime();
      timer = setInterval(() => {
        duration--;
        updateTime();
        
        // Add warning when time is running low
        if (duration === 30) {
          timerEl.classList.add("time-warning");
        }
        
        if (duration <= 0) {
          clearInterval(timer);
          submitQuiz();
        }
      }, 1000);
    }

    function updateTime() {
      const min = String(Math.floor(duration / 60)).padStart(2, '0');
      const sec = String(duration % 60).padStart(2, '0');
      timerEl.textContent = `Time: ${min}:${sec}`;
      
      // Update progress bar
      const progress = ((120 - duration) / 120) * 100;
      progressBar.style.width = `${progress}%`;
      
      if (duration < 30) {
        progressBar.classList.remove("bg-primary");
        progressBar.classList.add("bg-danger");
      }
    }

    async function loadQuiz() {
      try {
        const loadingHtml = `
          <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading test questions...</p>
          </div>
        `;
        quizEl.innerHTML = loadingHtml;
        
        const res = await fetch("https://opensheet.elk.sh/1xvjS3P9mzB4FyGvub14r99zWIA3zh7v84WFo_ZLoRV8/1");
        quizData = (await res.json()).filter(q => q.Question);
        total = quizData.length;
        renderQuiz();
      } catch (e) {
        quizEl.innerHTML = `
          <div class="alert alert-danger">
            <h5>Failed to load quiz</h5>
            <p>Please check your internet connection and try again.</p>
            <button class="btn btn-warning" onclick="window.location.reload()">Reload Page</button>
          </div>
        `;
      }
    }

    function renderQuiz() {
      quizEl.innerHTML = "";
      quizData.forEach((q, i) => {
        const div = document.createElement("div");
        div.className = "question-box";
        div.id = `question-${i}`;

        const options = ["A", "B", "C", "D"].map(opt => `
          <div class="form-check">
            <input class="form-check-input" type="radio" name="q${i}" id="q${i}_${opt}" value="${opt}" data-index="${i}">
            <label class="form-check-label option-label" for="q${i}_${opt}">
              ${opt}) ${q[opt] || ""}
            </label>
          </div>
        `).join("");

        div.innerHTML = `
          <h5><span class="question-number">${q["No."]}.</span> ${q.Question}</h5>
          ${options}
          <p class="explanation" id="exp${i}">${q.Explanation || "No explanation available."}</p>
        `;
        quizEl.appendChild(div);
      });

      // Attach event listeners
      quizData.forEach((q, i) => {
        const inputs = document.querySelectorAll(`input[name="q${i}"]`);
        inputs.forEach(input => {
          input.addEventListener("change", () => {
            const selected = input.value;
            const correct = q.Answer;
            const explanation = document.getElementById(`exp${i}`);
            explanation.style.display = "block";

            // Store user answer
            userAnswers[i] = {
              question: q.Question,
              selected: selected,
              correct: correct,
              isCorrect: selected === correct,
              explanation: q.Explanation || "No explanation available."
            };

            // Disable all inputs for this question
            inputs.forEach(inp => {
              inp.disabled = true;
              const label = document.querySelector(`label[for="${inp.id}"]`);
              label.classList.remove("correct", "wrong");

              if (inp.value === correct) label.classList.add("correct");
              else if (inp.checked && inp.value !== correct) label.classList.add("wrong");
            });

            // Update score and answered count
            answeredQuestions++;
            if (selected === correct) score++;
            
            // Update progress
            updateAnsweredProgress();
            
            // Scroll to next unanswered question
            scrollToNextUnanswered();
          });
        });
      });
      
      // Initialize progress
      updateAnsweredProgress();
      
      // Add submit event listeners
      submitBtn.addEventListener("click", showConfirmationModal);
      bottomSubmitBtn.addEventListener("click", showConfirmationModal);
      confirmSubmitBtn.addEventListener("click", submitQuiz);
    }
    
    function updateAnsweredProgress() {
      const progress = Math.round((answeredQuestions / total) * 100);
      progressBar.style.width = `${progress}%`;
      progressBar.setAttribute('aria-valuenow', progress);
      progressBar.textContent = `${answeredQuestions}/${total} answered`;
    }
    
    function scrollToNextUnanswered() {
      for (let i = 0; i < quizData.length; i++) {
        const inputs = document.querySelectorAll(`input[name="q${i}"]`);
        const anyChecked = Array.from(inputs).some(input => input.checked);
        
        if (!anyChecked) {
          document.getElementById(`question-${i}`).scrollIntoView({
            behavior: 'smooth',
            block: 'center'
          });
          break;
        }
      }
    }
    
    function showConfirmationModal() {
      answeredCountEl.textContent = answeredQuestions;
      totalCountEl.textContent = total;
      confirmationModal.show();
    }

    function submitQuiz() {
      clearInterval(timer);
      confirmationModal.hide();
      quizContainer.classList.add("d-none");
      resultSection.classList.remove("d-none");
      
      const endTime = new Date();
      const timeTaken = Math.round((endTime - startTime) / 1000);
      const minutes = Math.floor(timeTaken / 60);
      const seconds = timeTaken % 60;
      
      // Display results
      scoreDisplay.textContent = `${currentUser}'s Test Results`;
      scorePercentageEl.textContent = `${Math.round((score / total) * 100)}%`;
      scoreFractionEl.textContent = `${score} out of ${total} correct`;
      timeTakenEl.textContent = `Time taken: ${minutes}m ${seconds}s`;
      
      // Render detailed results
      renderDetailedResults();
      
      // Render chart
      renderResultChart();
      
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    function renderDetailedResults() {
      let html = '';
      
      quizData.forEach((q, i) => {
        const userAnswer = userAnswers[i] || {
          selected: 'Not answered',
          isCorrect: false,
          explanation: q.Explanation || "No explanation available."
        };
        
        html += `
          <div class="mb-4 p-3 ${userAnswer.isCorrect ? 'bg-success bg-opacity-10' : 'bg-danger bg-opacity-10'} rounded">
            <h5>${q["No."]}. ${q.Question}</h5>
            <p class="mb-1"><strong>Your answer:</strong> 
              <span class="${userAnswer.isCorrect ? 'text-success' : 'text-danger'}">
                ${userAnswer.selected}${userAnswer.selected === 'Not answered' ? '' : `) ${q[userAnswer.selected] || ''}`}
              </span>
            </p>
            <p class="mb-1"><strong>Correct answer:</strong> ${q.Answer}) ${q[q.Answer] || ''}</p>
            <p class="mb-0"><strong>Explanation:</strong> ${userAnswer.explanation}</p>
          </div>
        `;
      });
      
      resultDetailsEl.innerHTML = html;
    }
    
    function renderResultChart() {
      const correctCount = score;
      const incorrectCount = answeredQuestions - score;
      const unansweredCount = total - answeredQuestions;
      
      const ctx = resultChartEl.getContext('2d');
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Correct', 'Incorrect', 'Unanswered'],
          datasets: [{
            data: [correctCount, incorrectCount, unansweredCount],
            backgroundColor: [
              '#28a745',
              '#dc3545',
              '#6c757d'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const percentage = Math.round((value / total) * 100);
                  return `${label}: ${value} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }
    
    // Restart buttons
    restartBtn.addEventListener('click', () => {
      resultSection.classList.add('d-none');
      quizContainer.classList.remove('d-none');
      score = 0;
      answeredQuestions = 0;
      userAnswers = [];
      duration = 120;
      startTime = new Date();
      renderQuiz();
      startTimer();
    });
    
    newUserBtn.addEventListener('click', () => {
      resultSection.classList.add('d-none');
      userSelection.classList.remove('d-none');
      introSection.classList.remove('d-none');
      score = 0;
      answeredQuestions = 0;
      userAnswers = [];
      duration = 120;
      quizEl.innerHTML = '';
    });
  </script>
</body>
</html>
